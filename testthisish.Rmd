---
title: "test it"
author: "Theresa Alexander"
date: "2/5/2021"
output:
  html_document:
    theme: readable
    highlight: kate
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cars}
load("~/Downloads/sincell_with_class_5cl.RData")

library("scran")
library("scater")
library("igraph")
library("Rtsne")
library("stats")
library("mclust")
library("ggplot2")
library("gridExtra")
library("irlba")
library("MASS")
library("klaR")
library("dplyr")
```


# SCE 5 cluster dataset
```{r}
#scran normalize
sce_sc_10x_5cl_qc <- computeSumFactors(sce_sc_10x_5cl_qc)
sce_sc_10x_5cl_qc <- logNormCounts(sce_sc_10x_5cl_qc)

#get variable genes
stats <- scran::modelGeneVar(logcounts(sce_sc_10x_5cl_qc))
var.features <- scran::getTopHVGs(stats, n = 3000)

#PCA reduction
sce_sc_10x_5cl_qc <- runPCA(sce_sc_10x_5cl_qc, subset = var.features)

#tsne of varfeatures(logcounts)
sce10x_5cl_tsne_data <- Rtsne(t(logcounts(sce_sc_10x_5cl_qc)[var.features,]))


Cell_line <- sce_sc_10x_5cl_qc$cell_line_demuxlet

#plot tsne dims
ggplot(as.data.frame(sce10x_5cl_tsne_data$Y), aes(x = sce10x_5cl_tsne_data$Y[,1], y = sce10x_5cl_tsne_data$Y[,2], col=Cell_line)) + 
  geom_point() +
  theme_classic() +
  ggtitle("sc_10x 5 Cell Lines, tSNE of original data") +
  xlab("TSNE 1") +
  ylab("TSNE 2") 
```


```{r}
latentdim <- reducedDim(sce_sc_10x_5cl_qc,"PCA")[,1:10]
datadim <- t(logcounts(sce_sc_10x_5cl_qc)[var.features,])
```


#Cluster in latent space

```{r}
#truth
groundtruth <- sce_sc_10x_5cl_qc$cell_line

set.seed(123)
sce10x_5cl_tsne <- Rtsne(reducedDim(sce_sc_10x_5cl_qc,"PCA", subset = var.features)[,1:10])

#plot tsne dims
ggplot(as.data.frame(sce10x_5cl_tsne$Y), aes(x = sce10x_5cl_tsne$Y[,1], y = sce10x_5cl_tsne$Y[,2], col= Cell_line)) + 
  geom_point() +
  theme_classic() +
  ggtitle("sc_10x 5 Cell Lines pf PCA embedding") +
  xlab("TSNE 1") +
  ylab("TSNE 2") 
```


# Test over different K's
```{r}
#so we don't have to keep calculating this
distdata <- as.matrix(dist(datadim))
distlatent <- as.matrix(dist(latentdim))


k10_improvedKNN <- improvedKNN(sce_sc_10x_5cl_qc$cell_line, datadim = datadim, latentdim = latentdim, k = 10, distdata = distdata, distlatent = distlatent)
k20_improvedKNN <- improvedKNN(sce_sc_10x_5cl_qc$cell_line, datadim = datadim, latentdim = latentdim, k = 20, distdata = distdata, distlatent = distlatent)
k30_improvedKNN <- improvedKNN(sce_sc_10x_5cl_qc$cell_line, datadim = datadim, latentdim = latentdim, k = 30, distdata = distdata, distlatent = distlatent)
k40_improvedKNN <- improvedKNN(sce_sc_10x_5cl_qc$cell_line, datadim = datadim, latentdim = latentdim, k = 40, distdata = distdata, distlatent = distlatent)
k50_improvedKNN <- improvedKNN(sce_sc_10x_5cl_qc$cell_line, datadim = datadim, latentdim = latentdim, k = 50, distdata = distdata, distlatent = distlatent)
k60_improvedKNN <- improvedKNN(sce_sc_10x_5cl_qc$cell_line, datadim = datadim, latentdim = latentdim, k = 60, distdata = distdata, distlatent = distlatent)
k70_improvedKNN <- improvedKNN(sce_sc_10x_5cl_qc$cell_line, datadim = datadim, latentdim = latentdim, k = 70, distdata = distdata, distlatent = distlatent)
k80_improvedKNN <- improvedKNN(sce_sc_10x_5cl_qc$cell_line, datadim = datadim, latentdim = latentdim, k = 80, distdata = distdata, distlatent = distlatent)
k90_improvedKNN <- improvedKNN(sce_sc_10x_5cl_qc$cell_line, datadim = datadim, latentdim = latentdim, k = 90, distdata = distdata, distlatent = distlatent)
k100_improvedKNN <- improvedKNN(sce_sc_10x_5cl_qc$cell_line, datadim = datadim, latentdim = latentdim, k = 100, distdata = distdata, distlatent = distlatent)



improvedKNNs <- c(k10_improvedKNN, k20_improvedKNN, k30_improvedKNN, k40_improvedKNN, k50_improvedKNN, k60_improvedKNN, k70_improvedKNN, k80_improvedKNN, k90_improvedKNN, k100_improvedKNN)

ggplot(data.frame(k = seq(10,100, by = 10), improvedKNN = improvedKNNs), aes(x = as.factor(k), y = improvedKNN)) + 
  geom_point()+
  theme_classic() +
  xlab("number of neighbors (k)") +
  ylab("improvedKNN")

```

